{% extends 'base.html' %}
{% block content %}

<div class="container my-5">

    <!-- بخش محصول -->
    <div class="row align-items-center">

        <!-- اطلاعات محصول – سمت چپ -->
        <div class="col-md-7 text-end">  <!-- اضافه شدن text-end برای راست‌چین -->
            <h2 class="mb-3">{{ obj.name }}</h2>
            <p class="text-muted" style="font-size: 16px;">
                قیمت: <b>{{ obj.price }} تومان</b>
            </p>

            {% if obj.discount > 0 %}
                <p><span class="badge bg-danger">تخفیف {{ obj.discount }}%</span></p>
            {% endif %}

            <a href="{% url 'shop:cart_add' obj.id %}"
               data-id="{{ obj.id }}"
               class="btn btn-success mb-4 add-to-cart-link">
                افزودن به سبد خرید
            </a>

            <script>
                $('.add-to-cart-link').click(function (e) {
                    e.preventDefault()
                    let target_link = $(this).attr('href')
                    $.get(target_link, function (res) {
                        let item_count = Object.keys(res).length
                        $('#cart-count').html(item_count)
                    })
                    return false
                })
            </script>

            <hr>

            <h4 class="mt-4">توضیحات محصول</h4>
            <p style="font-size: 15px; line-height: 1.7; text-align: right;">
                {% autoescape off %}{{ obj.description }}{% endautoescape %}
            </p>
        </div>

        <!-- تصویر محصول – سمت راست -->
        <div class="col-md-5 text-center">
            {% if obj.image %}
                <img class="img-fluid rounded shadow-sm" src="{{ obj.image.url }}" alt="">
            {% else %}
                <img class="img-fluid rounded shadow-sm"
                     src="https://via.placeholder.com/400x400?text=No+Image" alt="">
            {% endif %}
        </div>
    </div>

    <!-- بخش کامنت‌ها -->
    <div class="row mt-5">
        <div class="col-md-12">
            <div class="card p-4 shadow-sm text-end"> <!-- text-end برای راست‌چین کامنت‌ها -->

                <h5 class="fw-bold mb-3">کامنت‌ها</h5>

                {% for c in obj.comments.all %}
                    {% if c.enable %}
                        <div class="border rounded p-3 mb-3 bg-light text-end">
                            <div class="d-flex justify-content-between">
                                <strong>{{ c.user.username }}</strong>
                                <small class="text-muted">{{ c.created_at|date:"Y/m/d H:i" }}</small>
                            </div>
                            <p class="mt-2 mb-0" style="white-space: pre-line;">{{ c.text }}</p>
                        </div>
                    {% endif %}
                {% empty %}
                    <p class="text-muted">فعلاً هیچ کامنتی ثبت نشده.</p>
                {% endfor %}

                <hr class="my-4">

                {% if user.is_authenticated %}
                    <h6 class="fw-bold mb-2">ارسال کامنت جدید</h6>
                    <form method="post" class="text-end">
                        {% csrf_token %}
                        <textarea name="text" rows="4" class="form-control mb-2" placeholder="نظر خود را وارد کنید..."></textarea>
                        <button class="btn btn-success w-100">ارسال کامنت</button>
                    </form>
                {% else %}
                    <p class="text-danger">برای ارسال کامنت ابتدا باید وارد شوید.</p>
                {% endif %}

            </div>
        </div>
    </div>

</div>

{% endblock %}
